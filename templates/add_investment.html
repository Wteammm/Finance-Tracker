{% extends 'base.html' %}

{% block dashboard %}investment{% endblock %}
{% block dashboard_title %}Add Investment{% endblock %}

{% block top_nav %}
<a href="{{ url_for('forex') }}" class="{% if request.endpoint == 'forex' %}active{% endif %}">Forex Manager</a>
<a href="{{ url_for('add_investment') }}" class="active">Add Investment</a>
<a href="{{ url_for('portfolio_overview') }}"
    class="{% if request.endpoint == 'portfolio_overview' %}active{% endif %}">Portfolio Overview</a>
{% endblock %}


{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white">
                <h4 class="mb-0">Add Investment Transaction</h4>
            </div>
            <div class="card-body">
                <form method="POST" id="investmentForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="type" class="form-label">Type</label>
                            <select class="form-select" id="type" name="type" required>
                                <option value="Buy">Buy</option>
                                <option value="Sell">Sell</option>
                                <option value="Dividend">Dividend</option>
                                <option value="Bonus">Bonus Share</option>
                                <option value="Split">Share Split</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="symbol" class="form-label">Symbol</label>
                            <input type="text" class="form-control" id="symbol" name="symbol"
                                placeholder="e.g. AAPL, BTC, 1155.KL" required>
                        </div>
                        <div class="col-md-6">
                            <label for="market" class="form-label">Market</label>
                            <select class="form-select" id="market" name="market" required>
                                <option value="US">US Stock</option>
                                <option value="MY">MY Stock</option>
                                <option value="Crypto">Crypto</option>
                                <option value="MMF-RM">MMF-RM</option>
                                <option value="MMF-USD">MMF-USD</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input type="number" step="any" class="form-control" id="quantity" name="quantity" required>
                        </div>
                        <div class="col-md-4">
                            <label for="price" class="form-label">Price</label>
                            <input type="number" step="any" class="form-control" id="price" name="price" required>
                        </div>
                        <div class="col-md-4">
                            <label for="fees" class="form-label">Fees</label>
                            <input type="number" step="0.01" class="form-control" id="fees" name="fees" value="0.00">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="currency" class="form-label">Currency</label>
                            <select class="form-select" id="currency" name="currency" required>
                                <option value="MYR">MYR</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label for="brokerage" class="form-label">Brokerage Account</label>
                            <input type="text" class="form-control" id="brokerage" name="brokerage"
                                placeholder="e.g., Moomoo, Maybank Trade, Interactive Brokers">
                            <div class="form-text">Optional: Which trading platform/broker</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="remark" class="form-label">Remark</label>
                            <input type="text" class="form-control" id="remark" name="remark"
                                placeholder="Optional notes">
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">Add Transaction</button>
                        <a href="{{ url_for('portfolio') }}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Set default date to today
    document.getElementById('date').valueAsDate = new Date();

    // Holdings data from backend
    const holdings = {{ holdings| tojson | safe }};

    // Auto-select currency based on market
    const marketSelect = document.getElementById('market');
    const currencySelect = document.getElementById('currency');
    const typeSelect = document.getElementById('type');
    const symbolInput = document.getElementById('symbol');
    const quantityInput = document.getElementById('quantity');

    // Smart Sell functionality
    let sellHoldingsSelect = null;
    let maxQuantity = 0;

    typeSelect.addEventListener('change', function () {
        if (this.value === 'Sell') {
            // Show holdings dropdown
            if (!sellHoldingsSelect) {
                sellHoldingsSelect = document.createElement('select');
                sellHoldingsSelect.className = 'form-select mb-2';
                sellHoldingsSelect.id = 'sellHoldings';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a holding to sell';
                sellHoldingsSelect.appendChild(defaultOption);

                holdings.forEach(h => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(h);
                    option.textContent = `${h.symbol} (${h.market}) - Available: ${h.quantity}`;
                    sellHoldingsSelect.appendChild(option);
                });

                symbolInput.parentNode.insertBefore(sellHoldingsSelect, symbolInput);
            }

            sellHoldingsSelect.style.display = 'block';
            symbolInput.readOnly = true;
            symbolInput.placeholder = 'Select from dropdown above';

            // Handle holding selection
            sellHoldingsSelect.addEventListener('change', function () {
                if (this.value) {
                    const holding = JSON.parse(this.value);
                    symbolInput.value = holding.symbol;
                    marketSelect.value = holding.market;
                    currencySelect.value = holding.currency;
                    maxQuantity = holding.quantity;
                    quantityInput.max = maxQuantity;
                    quantityInput.placeholder = `Max: ${maxQuantity}`;

                    // Make market and currency readonly (not disabled, so they submit)
                    marketSelect.style.pointerEvents = 'none';
                    marketSelect.style.backgroundColor = '#e9ecef';
                    currencySelect.style.pointerEvents = 'none';
                    currencySelect.style.backgroundColor = '#e9ecef';
                }
            });

            // Validate quantity
            quantityInput.addEventListener('input', function () {
                if (maxQuantity > 0 && parseFloat(this.value) > maxQuantity) {
                    this.value = maxQuantity;
                    alert(`Maximum quantity available: ${maxQuantity}`);
                }
            });

        } else {
            // Hide holdings dropdown for other types
            if (sellHoldingsSelect) {
                sellHoldingsSelect.style.display = 'none';
            }
            symbolInput.readOnly = false;
            symbolInput.placeholder = 'e.g. AAPL, BTC, 1155.KL';
            symbolInput.value = '';
            marketSelect.style.pointerEvents = 'auto';
            marketSelect.style.backgroundColor = '';
            currencySelect.style.pointerEvents = 'auto';
            currencySelect.style.backgroundColor = '';
            quantityInput.removeAttribute('max');
            quantityInput.placeholder = '';
            maxQuantity = 0;
        }
    });

    marketSelect.addEventListener('change', function () {
        const market = this.value;
        if (market === 'US') {
            currencySelect.value = 'USD';
        } else if (market === 'MY') {
            currencySelect.value = 'MYR';
        } else if (market === 'Crypto') {
            currencySelect.value = 'MYR';
        } else if (market === 'MMF-RM') {
            currencySelect.value = 'MYR';
        } else if (market === 'MMF-USD') {
            currencySelect.value = 'USD';
        }
    });

    // Offline Form Handling for Investment
    const investmentForm = document.getElementById('investmentForm');
    if (investmentForm) {
        investmentForm.addEventListener('submit', async function (e) {
            // Check if we're offline
            if (!navigator.onLine) {
                e.preventDefault(); // Prevent normal form submission

                // Get form data
                const formData = {
                    date: document.getElementById('date').value,
                    type: document.getElementById('type').value,
                    symbol: document.getElementById('symbol').value,
                    market: document.getElementById('market').value,
                    quantity: document.getElementById('quantity').value,
                    price: document.getElementById('price').value,
                    fees: document.getElementById('fees').value,
                    currency: document.getElementById('currency').value,
                    brokerage: document.getElementById('brokerage').value,
                    remark: document.getElementById('remark').value
                };

                try {
                    // Save to IndexedDB
                    await offlineDB.addInvestment(formData);

                    // Show success message
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-warning alert-dismissible fade show';
                    alert.innerHTML = `
                        <strong>⚠️ Offline Mode:</strong> Investment saved locally. Will sync when online.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    investmentForm.insertAdjacentElement('beforebegin', alert);

                    // Reset form
                    investmentForm.reset();
                    document.getElementById('date').valueAsDate = new Date();

                    // Update sync status
                    await syncManager.updateStatus();

                    // Auto-remove alert after 5 seconds
                    setTimeout(() => alert.remove(), 5000);
                } catch (error) {
                    console.error('Failed to save offline:', error);
                    alert('Failed to save investment offline. Please try again.');
                }
            }
            // If online, let the form submit normally
        });
    }
</script>
{% endblock %}